#vulnerability scoring data and biofouling
library(tidyverse)
library(readxl)

ebd_data <- ebirdst_runs %>%
  select(c("species_code","scientific_name","common_name"))

complete <- list.files(path = "D:/floating_solar/generated/")
complete_codes <- str_extract(complete,"[^_]+")

species_selection <- ebd_data %>%
  filter(species_code %in% complete_codes)

#resilience
#### CCS ####
acad <- read_excel("data/ACAD Global 2024.05.23.xlsx")


acad1 <- acad %>%
  select(c("Common Name","Scientific Name","Group","order","family","CCS-max"))
colnames(acad1) <- c("common_name","scientific_name","group","order","family","CCS-max")

species_selection1 <- left_join(species_selection,acad1, by = "scientific_name")
write.csv(species_selection1,"data/species_data_floating_solar.csv") #fixing a few merging errors manually
species_selection1 <- read.csv("data/species_data_floating_solar.csv")
#all species have CCS-max



#biofouling
#### biofouling ####

poop <- read_excel("data/biofouling_data.xlsx",1)

poop1 <- poop %>%
  filter(measured == "y")

poop_summary <- poop1 %>%
  group_by(species)%>%
  summarise(mean_mass = mean(mass),
            mean_def = mean(defecation_rate_g_per_day_dry))

plot(poop_summary$mean_mass, poop_summary$mean_def)

#check by 2.25% estimate

poop_summary$estimated_def_rate <- poop_summary$mean_mass*0.0225

plot(poop_summary$mean_def,poop_summary$estimated_def_rate)

#what percent would we assume from data?

poop_summary$percent_weight <- poop_summary$mean_def/poop_summary$mean_mass

plot(poop_summary$mean_mass,poop_summary$percent_weight)
plot(poop_summary$mean_mass,poop_summary$mean_def)
plot(log(poop_summary$mean_mass),log(poop_summary$mean_def)) #YES - allometric change in fecal volume with body mass
#can estimate reasonably well using a linear relationship and log-log scale

colnames(poop_summary) <- c("species","bodymass","defecation_rate")
poop_summary$log_def_rate <- log(poop_summary$defecation_rate)
poop_summary$log_bodymass <- log(poop_summary$bodymass)

biof_mod <- lm(log_def_rate ~ log_bodymass, data = poop_summary)
biof_mod
plot(biof_mod,1)
summary(biof_mod)

#now need to predict values for species in our analysis

species_data <- read.csv("data/species_data_floating_solar.csv")
#following steps are done and don't need to be repeated
# elton <- read_excel("data/Elton_traits.xlsx")%>%
#   select(c("Scientific","English","BodyMass-Value"))
# colnames(elton) <- c("scientific_name","English","bodymass")
# 
# species_data1 <- left_join(species_data,elton, by = "scientific_name")
# colnames(elton) <- c("scientific_name","common_name","bodymass")
# 
# write.csv(species_data1, file = "data/species_data_biomass.csv")
#write to csv and manually fill in missing values

#datasheet with missing mass values filled in
bodymass_data <- read.csv("data/species_data_biomass.csv")
bodymass_data$log_bodymass <- log(bodymass_data$bodymass)


bodymass_data$log_predicted_defecation_rate <- predict(biof_mod, newdata = bodymass_data)
bodymass_data$predicted_defecation_rate <- exp(bodymass_data$log_predicted_defecation_rate)

write.csv(bodymass_data, file = "data/species_data_CCS_habitat_biofouling.csv")

data <- read.csv("data/species_data_CCS_habitat_biofouling.csv")

load("D:/floating_solar/data_outputs/lake_ave_biodiversity.RData")

lake_biodiversity_df$presence <- ifelse(lake_biodiversity_df$max>0,1,0)

# test<- lake_biodiversity_df %>%
#   filter(species_code == "pilwoo")

#for each lake, what if we add the defecation rate 

#scale defecation rates between 0 and 1
data$defecation_score <- data$predicted_defecation_rate/max(data$predicted_defecation_rate)

#join to lake data
lake_biofoul_data <- left_join(lake_biodiversity_df,data, by = "species_code")

#calculate biofouling score multiplying defecation score by abd_prop
lake_biofoul_data$biofouling_risk <- lake_biofoul_data$max*lake_biofoul_data$defecation_score

#summarise by lake - sum the values calculated above
lake_biof_sum <- lake_biofoul_data %>%
  group_by(Water_ID)%>%
  summarise(sum_biofoul_risk = sum(biofouling_risk, na.rm = T))

load("D:/floating_solar/data_outputs/all_importance_data.RData")

all_data2 <- left_join(all_data1,lake_biof_sum, by = "Water_ID")
save(all_data2,file="D:/floating_solar/data_outputs/all_importance_data.RData")
rm(lake_biofoul_data)

#need to do all of this for the mean values as well...


#adaptive capacity
#### axial length ####

# #Froelich
# axial_length1 <- read_excel("data/froelich_2024_axiallength.xlsx",1)%>%
#   select(c("species","EyeAxialLen"))
# 
# colnames(axial_length1) <- c("scientific_name","axial_length_mm")
# 
# axial_length1$scientific_name <- sub("_"," ", axial_length1$scientific_name)
# #length(setdiff(species_selection1$scientific_name,axial_length_2$scientific_name))
# sum(is.na(axial_length1$axial_length_mm))
#100 species don't have axial length data, use Liu data instead
#BUT can use to check predictions


#Liu
# axial_length2 <- read.csv("data/Liu_2023_axiallength.csv")%>%
#   select(c("scientific_name","Axial_length_mm","body_mass_g"))
# 
# axial_length2$scientific_name <- sub("_"," ", axial_length2$scientific_name)
# #length(setdiff(species_selection1$scientific_name,axial_length$scientific_name))
# 
# #species_selection2 <- left_join(species_selection1,axial_length)
# 
# plot(log(axial_length2$Axial_length_mm), log(axial_length2$body_mass_g)) #looks good on log-log scale
# 
# axial_length2$log_axial_length <- log(axial_length2$Axial_length_mm)
# axial_length2$log_bodymass <- log(axial_length2$body_mass_g)
# 
# 
# axial_mod <- lm(log_axial_length ~ log_bodymass, data = axial_length2) #adj rsq of 0.783
# axial_mod
# plot(axial_mod,1)
# summary(axial_mod)
# 
# data <- read.csv("data/species_data_CCS_habitat_biofouling.csv")
# 
# data$log_predicted_axiallength <- predict(axial_mod, newdata = data)
# data$predicted_axiallength <- exp(data$log_predicted_axiallength)
# 
# write.csv(data, file = "data/species_data_CCS_habitat_biofouling_axlength.csv")
# 
# #checks
# length(setdiff(data$scientific_name, axial_length1$scientific_name))
# 
# axial_predictions <- data %>%
#   select(c("scientific_name","common_name.x","predicted_axiallength"))
# 
# axial_length_froelich <- read_excel("data/froelich_2024_axiallength.xlsx",1)%>%
#   select(c("species","EyeAxialLen"))
# 
# colnames(axial_length_froelich) <- c("scientific_name","axial_length_measured")
# 
# axial_length_froelich$scientific_name <- sub("_"," ", axial_length_froelich$scientific_name)
# 
# check_data <- left_join(axial_predictions,axial_length_froelich, by = "scientific_name")%>%
#   drop_na(axial_length_measured)
# 
# plot(check_data$predicted_axiallength, check_data$axial_length_measured, xlim = c(0,40), ylim = c(0,40))
#might need a family level interaction here... think owls, raptors

#data$order <- as.factor(data$order)
# liu_orders <- unique(axial_length2$Order)
# my_orders <- unique(data$order)
# setdiff(my_orders,liu_orders)


axial_length_froelich <- read_excel("data/froelich_2024_axiallength.xlsx",1)%>%
  select(c("species","order","BodyMass","EyeAxialLen"))

colnames(axial_length_froelich) <- c("scientific_name","order","body_mass_g","axial_length_mm")
axial_length_froelich$scientific_name <- sub("_"," ", axial_length_froelich$scientific_name)
axial_length_froelich$axial_length_mm <- as.numeric(axial_length_froelich$axial_length_mm)
axial_length_froelich <- axial_length_froelich %>%
  drop_na(axial_length_mm)
axial_length_froelich$order <- as.factor(axial_length_froelich$order)

axial_length_liu <- read.csv("data/Liu_2023_axiallength.csv")%>%
  select(c("scientific_name","Order","body_mass_g","Axial_length_mm"))
axial_length_liu$scientific_name <- sub("_"," ", axial_length_liu$scientific_name)
colnames(axial_length_liu) <- c("scientific_name","order","body_mass_g","axial_length_mm")

al_data <- rbind(axial_length_froelich,axial_length_liu)
axl_data <- al_data %>%
  group_by(scientific_name,order)%>%
  summarise(body_mass_g = mean(body_mass_g),
            axial_length_mm = mean(axial_length_mm))

save(axl_data, file = "data/axial_length_data_clean.RData")



#start here now

data <- read.csv("data/species_data_CCS_habitat_biofouling.csv")

load("data/axial_length_data_clean.RData")

training_orders <- unique(axl_data$order)
test_orders <- unique(data$order)
setdiff(test_orders, training_orders)

axl_data1 <- axl_data %>%
  filter(order %in% test_orders)
length(unique(axl_data1$order))


ggplot(data = axl_data1, aes(x = log(body_mass_g), y = log(axial_length_mm), col = order))+
  #geom_point()+
  geom_smooth(method = "lm")

#try to figure out brms model next, interaction between order*body_mass_g


