#vulnerability scoring data and biofouling

library(readxl)

ebd_data <- ebirdst_runs %>%
  select(c("species_code","scientific_name","common_name"))

complete <- list.files(path = "D:/floating_solar/generated/")
complete_codes <- str_extract(complete,"[^_]+")

species_selection <- ebd_data %>%
  filter(species_code %in% complete_codes)

#resilience
#### CCS ####
acad <- read_excel("data/ACAD Global 2024.05.23.xlsx")


acad1 <- acad %>%
  select(c("Common Name","Scientific Name","Group","order","family","CCS-max"))
colnames(acad1) <- c("common_name","scientific_name","group","order","family","CCS-max")

species_selection1 <- left_join(species_selection,acad1, by = "scientific_name")
write.csv(species_selection1,"data/species_data_floating_solar.csv") #fixing a few merging errors manually
species_selection1 <- read.csv("data/species_data_floating_solar.csv")
#all species have CCS-max

#adaptive capacity
#### axial length ####

axial_length <- read.csv("data/eye_axial_length.csv")
axial_length$scientific_name <- sub("_"," ", axial_length$scientific_name)
length(setdiff(species_selection1$scientific_name,axial_length$scientific_name))

species_selection2 <- left_join(species_selection1,axial_length)

#different dataset
axial_length_2 <- read_excel("data/froelich_2024_axiallength.xlsx")%>%
  select(c("species","EyeAxialLen"))
colnames(axial_length_2) <- c("scientific_name","axial_length_mm")

axial_length_2$scientific_name <- sub("_"," ", axial_length_2$scientific_name)
length(setdiff(species_selection1$scientific_name,axial_length_2$scientific_name))


#biofouling
#### biofouling ####

poop <- read_excel("data/biofouling_data.xlsx",1)

poop1 <- poop %>%
  filter(measured == "y")

poop_summary <- poop1 %>%
  group_by(species)%>%
  summarise(mean_mass = mean(mass),
            mean_def = mean(defecation_rate_g_per_day_dry))

plot(poop_summary$mean_mass, poop_summary$mean_def)

#check by 2.25% estimate

poop_summary$estimated_def_rate <- poop_summary$mean_mass*0.0225

plot(poop_summary$mean_def,poop_summary$estimated_def_rate)

#what percent would we assume from data?

poop_summary$percent_weight <- poop_summary$mean_def/poop_summary$mean_mass

plot(poop_summary$mean_mass,poop_summary$percent_weight)
plot(poop_summary$mean_mass,poop_summary$mean_def)
plot(log(poop_summary$mean_mass),log(poop_summary$mean_def)) #YES - allometric change in fecal volume with body mass
#can estimate reasonably well using a linear relationship and log-log scale

biof_mod <- lm(log(mean_def) ~ log(mean_mass), data = poop_summary)
biof_mod
plot(biof_mod,1)

#now need to predict values for species in our analysis

species_data <- read.csv("data/species_data_floating_solar.csv")
elton <- read_excel("data/Elton_traits.xlsx")%>%
  select(c("Scientific","English","BodyMass-Value"))
colnames(elton) <- c("scientific_name","English","bodymass")

species_data1 <- left_join(species_data,elton, by = "scientific_name")
colnames(elton) <- c("scientific_name","common_name","bodymass")

write.csv(species_data1, file = "data/species_data_biomass.csv")
#write to csv and manually fill in missing values

bodymass_data <- read.csv("data/species_data_biomass.csv")

#not working - figure out how to do the predictions for each bodymass value in the dataset
defecation_rate <- predict(biof_mod, new.data = log(bodymass_data$bodymass))
